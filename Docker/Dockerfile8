FROM lmoresi/unimelb-debian-python:1.05

## =============================================================
## base - image ... whatever functionality you want to provide !
## This is my unix / python stuff (but it doesn't have underworld)
##
## This dockerfile builds an image from this content, and serves the
## sample web pages and notebooks at port 8080
##
## docker run -p 8181:8080 --name="docker-web-notebooks-test" -t lmoresi/lmoresi/docker-web-notebooks-module
## and then browse the docker VM ip address on port 8181 (for example)
##
## OR just use kitematic and click on the preview image
##
## =============================================================

## Grab (this) content from github

## Link your content to the "Content" directory at the root level of this module
## If you don't have any content then use the example content !!

RUN pip install mkdocs mkdocs-bootswatch

RUN mkdir /demonstration
WORKDIR /demonstration

## These are the build templates etc
ADD Data/Reference Data/Reference
ADD Data/Modules python_modules
ADD mkdocs.yml mkdocs.yml
ADD jupyter-server-theme jupyter-server-theme
ADD scripts scripts
ADD Documentation Documentation
ADD Notebooks Notebooks
ADD docs docs

# Stripy / Litho1pt0

RUN cd python_modules && \
       tar -xzf litho1pt0.tar.gz && \
       tar -xzf stripy.tar.gz && \
       cd ..

RUN cd python_modules/litho1pt0 && \
       python setup.py build && \
       python setup.py install && \
       cd ../..

RUN cd python_modules/stripy && \
      python setup.py build && \
      python setup.py install && \
      cd ../..

## Build the site (will also clean it out)


RUN ./scripts/run-sitebuilder8.py

# Create a non-privileged user to run the notebooks and switch to this user for the server

RUN useradd --create-home --home-dir /home/demon --shell /bin/bash --user-group demon
RUN chown -R demon:demon /demonstration

USER demon
ENV HOME=/demonstration
ENV SHELL=/bin/bash
ENV USER=demon

# Launch the notebook server from the Notebook directory
# but perhaps there is something else that would do this.

WORKDIR /demonstration

# Persistent / Shared space outside the container
VOLUME /demonstration/Data/Resources
VOLUME /demonstration/build

EXPOSE 8080 8081 8082 8082 8084 8085 8086 8087 8088
ENTRYPOINT ["/usr/local/bin/tini", "--"]

CMD scripts/run-jupyter8.py
